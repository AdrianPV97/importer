SET TERM ^ ;

create or alter procedure ms_cancela_anticipo 
as
declare variable importe numeric(15,2);
declare variable importe_cancelado numeric(15,2);
declare variable uuid varchar(40);
declare variable cobro integer;
declare variable docto_principal integer;
begin

FOR SELECT UUID FROM MS_ANTICIPOS_POR_CANCELAR WHERE ESTATUS = 'N' INTO :UUID
DO
BEGIN


SELECT DOCTO_ID FROM USOS_FOLIOS_FISCALES WHERE UUID = :UUID INTO :DOCTO_PRINCIPAL;
SELECT IMPORTE FROM IMPORTES_DOCTOS_CC WHERE DOCTO_CC_ACR_ID = :DOCTO_PRINCIPAL AND TIPO_IMPTE = 'R' INTO :IMPORTE;
SELECT DOCTO_CC_ID FROM IMPORTES_DOCTOS_CC WHERE DOCTO_CC_ACR_ID = :DOCTO_PRINCIPAL AND TIPO_IMPTE = 'R' INTO :COBRO;


DELETE FROM DOCTOS_CC WHERE DOCTO_CC_ID = :COBRO;
DELETE FROM IMPORTES_DOCTOS_CC WHERE DOCTO_CC_ACR_ID = :DOCTO_PRINCIPAL AND TIPO_IMPTE = 'R' ;
UPDATE IMPORTES_DOCTOS_CC SET CANCELADO = 'S' WHERE DOCTO_CC_ACR_ID = :DOCTO_PRINCIPAL AND TIPO_IMPTE = 'C' ;

INSERT INTO MS_POR_CANCELAR (DOCTO_CC_ID) VALUES (:DOCTO_PRINCIPAL);
UPDATE MS_ANTICIPOS_POR_CANCELAR SET ESTATUS = 'S' WHERE UUID = :UUID;

UPDATE MS_SALDO_CANCELADO SET IMPORTE = IMPORTE + :IMPORTE;

END
/*
:documento_base = :DOCTO_PRINCIPAL;

:documento_base = :DOCTO_PRINCIPAL;

*/

end^

SET TERM ; ^

/* Following GRANT statements are generated automatically */

GRANT SELECT,UPDATE ON MS_ANTICIPOS_POR_CANCELAR TO PROCEDURE MS_CANCELA_ANTICIPO;
GRANT SELECT ON USOS_FOLIOS_FISCALES TO PROCEDURE MS_CANCELA_ANTICIPO;
GRANT SELECT,DELETE,UPDATE ON IMPORTES_DOCTOS_CC TO PROCEDURE MS_CANCELA_ANTICIPO;
GRANT SELECT,DELETE ON DOCTOS_CC TO PROCEDURE MS_CANCELA_ANTICIPO;
GRANT INSERT ON MS_POR_CANCELAR TO PROCEDURE MS_CANCELA_ANTICIPO;
GRANT SELECT,UPDATE ON MS_SALDO_CANCELADO TO PROCEDURE MS_CANCELA_ANTICIPO;

/* Existing privileges on this procedure */

GRANT EXECUTE ON PROCEDURE MS_CANCELA_ANTICIPO TO SYSDBA;